-- =====================================================================
--  TOWER HEROES AUTOMATION ENGINE (CORE)
-- =====================================================================

local Players = game:GetService("Players")
local RS = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer

local Events = RS:WaitForChild("Events")
local TroopPlace = Events:WaitForChild("TroopPlace")     
local TroopEvent = Events:WaitForChild("TroopEvent")     
local SkipWaveRemote = Events:WaitForChild("SkipWave")   
local WizardEvent = Events:FindFirstChild("WizardEvent") 

local TroopFolder = workspace:WaitForChild("Troop")
local HeroFolder = RS:WaitForChild("Troops")

-- INTERNAL STATE
local State = {
    Costs = {},
    PlacementRules = {},
    UpgradeRules = {},
    WaveCallbacks = {},
    CurrentWave = 0,
    Running = false,
    AutoSkipEnabled = false,
    LastSkipValue = nil,
    Tracked = {},         
    OwnedByName = {},     
}

-- HELPERS
local function getTextFromLabelOrFrame(obj)
    if not obj then return nil end
    if obj:IsA("TextLabel") or obj:IsA("TextButton") or obj:IsA("TextBox") then return obj.Text end
    local label = obj:FindFirstChildWhichIsA("TextLabel", true)
    return label and label.Text or nil
end

local function getMana()
    local gui = player:FindFirstChild("PlayerGui")
    local amount = gui and gui:FindFirstChild("Amount", true)
    if not amount then return 0 end
    local text = getTextFromLabelOrFrame(amount) or ""
    return tonumber(text:match("%d+")) or 0
end

local function getWave()
    local gui = player:FindFirstChild("PlayerGui")
    local hb = gui and gui:FindFirstChild("HealthBar", true)
    local waveLabel = hb and hb:FindFirstChild("WaveNum")
    if not waveLabel then return 0 end
    local text = getTextFromLabelOrFrame(waveLabel) or ""
    return tonumber(text:match("Wave%s+(%d+)")) or 0
end

local function getSkipInfo()
    local gui = player:FindFirstChild("PlayerGui")
    local skip = gui and gui:FindFirstChild("Skip", true)
    local skipNum = skip and skip:FindFirstChild("SkipNum", true)
    if not skipNum then return nil, nil end
    local text = getTextFromLabelOrFrame(skipNum) or ""
    local current, max = text:match("(%d+)%s*/%s*(%d+)")
    return tonumber(current), tonumber(max)
end

local function findNewTroop(name, pos)
    local closest, bestDist = nil, math.huge
    for _, troop in ipairs(TroopFolder:GetChildren()) do
        if troop.Name == name and not State.Tracked[troop] then
            local dist = (troop:GetModelCFrame().Position - pos).Magnitude
            if dist < bestDist then bestDist = dist; closest = troop end
        end
    end
    if closest then
        State.Tracked[closest] = true
        State.OwnedByName[name] = State.OwnedByName[name] or {}
        table.insert(State.OwnedByName[name], closest)
    end
    return closest
end

-- GLOBAL API
getgenv().EnableAutoSkip = function() State.AutoSkipEnabled = true end
getgenv().DisableAutoSkip = function() State.AutoSkipEnabled = false end
getgenv().SetCost = function(name, cost) State.Costs[name] = cost end
getgenv().Place = function(name, x, y, z, wave)
    table.insert(State.PlacementRules, {wave = wave or 1, troop = name, pos = Vector3.new(x, y, z)})
end
getgenv().AddUpgradeRule = function(rule)
    table.insert(State.UpgradeRules, {
        name = rule.name, index = rule.index or 1, 
        minWave = rule.minWave or 0, minMana = rule.minMana or 0
    })
end

getgenv().StartAutomation = function()
    if State.Running then return end
    State.Running = true
    
    -- Skip Loop
    task.spawn(function()
        while true do
            if State.AutoSkipEnabled then
                local cur = getSkipInfo()
                if cur == 0 and cur ~= State.LastSkipValue then
                    task.wait(0.1)
                    SkipWaveRemote:FireServer()
                end
                State.LastSkipValue = cur
            end
            task.wait(0.5)
        end
    end)

    -- Main Loop
    task.spawn(function()
        local lastWave = -1
        while true do
            local w = getWave()
            if w ~= lastWave then
                lastWave = w
                State.CurrentWave = w
                if State.WaveCallbacks[w] then
                    for _, cb in ipairs(State.WaveCallbacks[w]) do task.spawn(cb) end
                end
            end
            for _, rule in ipairs(State.UpgradeRules) do
                if State.CurrentWave >= rule.minWave and getMana() >= rule.minMana then
                    local t = (State.OwnedByName[rule.name] or {})[rule.index]
                    if t and t.Parent == TroopFolder then TroopEvent:FireServer("Upgrade", t) end
                end
            end
            task.wait(1)
        end
    end)

    -- Register Placements
    for _, rule in ipairs(State.PlacementRules) do
        State.WaveCallbacks[rule.wave] = State.WaveCallbacks[rule.wave] or {}
        table.insert(State.WaveCallbacks[rule.wave], function()
            while getMana() < (State.Costs[rule.troop] or 0) do task.wait(0.5) end
            local temp = HeroFolder:FindFirstChild(rule.troop)
            TroopPlace:FireServer(temp)
            task.wait(0.3)
            TroopPlace:FireServer(temp, rule.pos, 0)
            task.wait(1.5)
            findNewTroop(rule.troop, rule.pos)
        end)
    end
    print("Engine Loaded and Started")
end
