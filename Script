-- =====================================================================
--  TOWER HEROES AUTOMATION ENGINE (MANA-PRIORITY)
-- =====================================================================

local Players = game:GetService("Players")
local RS = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer

local Events = RS:WaitForChild("Events")
local TroopPlace = Events:WaitForChild("TroopPlace")     
local TroopEvent = Events:WaitForChild("TroopEvent")     
local SkipWaveRemote = Events:WaitForChild("SkipWave")   

local TroopFolder = workspace:WaitForChild("Troop")
local HeroFolder = RS:WaitForChild("Troops")

local State = {
    EventQueue = {},      -- List of tasks to do in order
    Costs = {},
    Running = false,
    AutoSkipEnabled = false,
    LastSkipValue = nil,
    Tracked = {},         
    OwnedByName = {},     
}

-- UI HELPERS
local function getText(obj)
    if not obj then return nil end
    local label = (obj:IsA("TextLabel") or obj:IsA("TextButton")) and obj or obj:FindFirstChildWhichIsA("TextLabel", true)
    return label and label.Text or nil
end

local function getMana()
    local gui = player:FindFirstChild("PlayerGui")
    local amount = gui and gui:FindFirstChild("Amount", true)
    if not amount then return 0 end
    local txt = getText(amount)
    return txt and tonumber(txt:match("%d+")) or 0
end

local function getSkipValue()
    local gui = player:FindFirstChild("PlayerGui")
    local skipNum = gui and gui:FindFirstChild("SkipNum", true)
    if not skipNum then return nil end
    local txt = getText(skipNum)
    return txt and tonumber(txt:match("(%d+)")) or nil
end

local function trackTroop(name, pos)
    local closest, bestDist = nil, math.huge
    for _, troop in ipairs(TroopFolder:GetChildren()) do
        if troop.Name == name and not State.Tracked[troop] then
            local dist = (troop:GetModelCFrame().Position - pos).Magnitude
            if dist < bestDist then bestDist = dist; closest = troop end
        end
    end
    if closest then
        State.Tracked[closest] = true
        State.OwnedByName[name] = State.OwnedByName[name] or {}
        table.insert(State.OwnedByName[name], closest)
    end
end

-- GLOBAL API
getgenv().EnableAutoSkip = function() State.AutoSkipEnabled = true end
getgenv().DisableAutoSkip = function() State.AutoSkipEnabled = false end
getgenv().SetCost = function(name, cost) State.Costs[name] = cost end

-- New Queue-based Commands
getgenv().QueuePlace = function(name, x, y, z)
    table.insert(State.EventQueue, {type = "place", name = name, pos = Vector3.new(x, y, z)})
end

getgenv().QueueUpgrade = function(name, index, cost)
    table.insert(State.EventQueue, {type = "upgrade", name = name, index = index, cost = cost})
end

getgenv().StartAutomation = function()
    if State.Running then return end
    State.Running = true
    print("Automation Started (Mana-Priority Mode)")

    -- Skip Loop
    task.spawn(function()
        while true do
            if State.AutoSkipEnabled then
                local cur = getSkipValue()
                if cur == 0 and cur ~= State.LastSkipValue then
                    task.wait(0.1)
                    SkipWaveRemote:FireServer()
                end
                State.LastSkipValue = cur
            end
            task.wait(0.5)
        end
    end)

    -- Queue Processor (The Logic)
    task.spawn(function()
        while #State.EventQueue > 0 do
            local taskData = State.EventQueue[1]
            local cost = 0
            
            if taskData.type == "place" then
                cost = State.Costs[taskData.name] or 0
            else
                cost = taskData.cost or 0
            end

            -- Wait until we have enough mana
            if getMana() >= cost then
                table.remove(State.EventQueue, 1) -- Remove from queue

                if taskData.type == "place" then
                    local temp = HeroFolder:FindFirstChild(taskData.name)
                    TroopPlace:FireServer(temp)
                    task.wait(0.2)
                    TroopPlace:FireServer(temp, taskData.pos, 0)
                    task.wait(1.5)
                    trackTroop(taskData.name, taskData.pos)
                    print("Placed " .. taskData.name)
                elseif taskData.type == "upgrade" then
                    local t = (State.OwnedByName[taskData.name] or {})[taskData.index]
                    if t and t.Parent == TroopFolder then
                        TroopEvent:FireServer("Upgrade", t)
                        print("Upgraded " .. taskData.name .. " #" .. taskData.index)
                        task.wait(0.5) -- Small delay between upgrades
                    end
                end
            end
            task.wait(0.5)
        end
        print("All queue tasks completed!")
    end)
end
